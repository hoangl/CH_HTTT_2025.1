/*
SQLyog Ultimate v13.1.1 (64 bit)
MySQL - 10.4.32-MariaDB : Database - quanlyxekhach
*********************************************************************
*/

/*!40101 SET NAMES utf8 */;

/*!40101 SET SQL_MODE=''*/;

/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;
CREATE DATABASE /*!32312 IF NOT EXISTS*/`quanlyxekhach` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci */;

USE `quanlyxekhach`;

/*Table structure for table `bang_gia` */

DROP TABLE IF EXISTS `bang_gia`;

CREATE TABLE `bang_gia` (
  `MaTuyenDuong` varchar(4) NOT NULL,
  `MaLoaiXe` varchar(10) NOT NULL,
  `NgayBatDau` date NOT NULL,
  `NgayKetThuc` date DEFAULT NULL,
  `GiaVeNiemYet` decimal(10,2) NOT NULL,
  PRIMARY KEY (`MaTuyenDuong`,`MaLoaiXe`,`NgayBatDau`),
  KEY `MaLoaiXe` (`MaLoaiXe`),
  CONSTRAINT `bang_gia_ibfk_1` FOREIGN KEY (`MaTuyenDuong`) REFERENCES `tuyen_duong` (`MaTuyenDuong`),
  CONSTRAINT `bang_gia_ibfk_2` FOREIGN KEY (`MaLoaiXe`) REFERENCES `loai_xe` (`MaLoaiXe`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

/*Data for the table `bang_gia` */

insert  into `bang_gia`(`MaTuyenDuong`,`MaLoaiXe`,`NgayBatDau`,`NgayKetThuc`,`GiaVeNiemYet`) values 
('HNDN','GN24','2025-01-01',NULL,600000.00),
('HNDN','GN24','2025-04-28','2025-05-02',720000.00),
('HNDN','LX45','2025-01-01',NULL,450000.00),
('HNNA','LX30','2025-01-01',NULL,220000.00),
('HNNA','LX45','2025-01-01',NULL,250000.00),
('HNNA','LX45','2025-04-28','2025-05-02',300000.00),
('HNSG','GN12','2025-01-01',NULL,1200000.00),
('HNSG','GN24','2025-01-01',NULL,900000.00),
('HNSG','GN24','2025-04-28','2025-05-02',1080000.00),
('HNSG','LM09','2025-01-01',NULL,1500000.00);

/*Table structure for table `chuyen_xe` */

DROP TABLE IF EXISTS `chuyen_xe`;

CREATE TABLE `chuyen_xe` (
  `MaChuyenXe` varchar(50) NOT NULL,
  `MaXe` varchar(8) NOT NULL,
  `MaTuyenDuong` varchar(4) NOT NULL,
  `GioDi` datetime NOT NULL,
  `GioDen` datetime NOT NULL,
  `TrangThai` int(11) DEFAULT 1,
  PRIMARY KEY (`MaChuyenXe`),
  KEY `MaXe` (`MaXe`),
  KEY `MaTuyenDuong` (`MaTuyenDuong`),
  CONSTRAINT `chuyen_xe_ibfk_1` FOREIGN KEY (`MaXe`) REFERENCES `xe_khach` (`MaXe`),
  CONSTRAINT `chuyen_xe_ibfk_2` FOREIGN KEY (`MaTuyenDuong`) REFERENCES `tuyen_duong` (`MaTuyenDuong`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

/*Data for the table `chuyen_xe` */

insert  into `chuyen_xe`(`MaChuyenXe`,`MaXe`,`MaTuyenDuong`,`GioDi`,`GioDen`,`TrangThai`) values 
('HNDN29A111112025010108','29A11111','HNDN','2025-01-01 08:00:00','2025-01-01 18:00:00',2),
('HNDN29A111112025010220','29A11111','HNDN','2025-01-02 20:00:00','2025-01-03 06:00:00',2),
('HNDN29A111112025010408','29A11111','HNDN','2025-01-04 08:00:00','2025-01-04 18:00:00',2),
('HNDN29A111112025010520','29A11111','HNDN','2025-01-05 20:00:00','2025-01-06 06:00:00',2),
('HNDN29A111112025010708','29A11111','HNDN','2025-01-07 08:00:00','2025-01-07 18:00:00',2),
('HNDN29A111112025010820','29A11111','HNDN','2025-01-08 20:00:00','2025-01-09 06:00:00',2),
('HNDN29A111112025011008','29A11111','HNDN','2025-01-10 08:00:00','2025-01-10 18:00:00',2),
('HNDN29A111112025011120','29A11111','HNDN','2025-01-11 20:00:00','2025-01-12 06:00:00',2),
('HNDN29A111112025011308','29A11111','HNDN','2025-01-13 08:00:00','2025-01-13 18:00:00',2),
('HNDN29A111112025011420','29A11111','HNDN','2025-01-14 20:00:00','2025-01-15 06:00:00',2),
('HNDN29A111112025011608','29A11111','HNDN','2025-01-16 08:00:00','2025-01-16 18:00:00',2),
('HNDN29A111112025011720','29A11111','HNDN','2025-01-17 20:00:00','2025-01-18 06:00:00',2),
('HNDN29A111112025011908','29A11111','HNDN','2025-01-19 08:00:00','2025-01-19 18:00:00',2),
('HNDN29A111112025012020','29A11111','HNDN','2025-01-20 20:00:00','2025-01-21 06:00:00',2),
('HNDN29A111112025012208','29A11111','HNDN','2025-01-22 08:00:00','2025-01-22 18:00:00',2),
('HNDN29A111112025012320','29A11111','HNDN','2025-01-23 20:00:00','2025-01-24 06:00:00',2),
('HNDN29A111112025012508','29A11111','HNDN','2025-01-25 08:00:00','2025-01-25 18:00:00',2),
('HNDN29A111112025012620','29A11111','HNDN','2025-01-26 20:00:00','2025-01-27 06:00:00',2),
('HNDN29A111112025012808','29A11111','HNDN','2025-01-28 08:00:00','2025-01-28 18:00:00',2),
('HNDN29A111112025012920','29A11111','HNDN','2025-01-29 20:00:00','2025-01-30 06:00:00',2),
('HNDN29A111112025013108','29A11111','HNDN','2025-01-31 08:00:00','2025-01-31 18:00:00',2),
('HNDN29A111112025020120','29A11111','HNDN','2025-02-01 20:00:00','2025-02-02 06:00:00',2),
('HNDN29A111112025020308','29A11111','HNDN','2025-02-03 08:00:00','2025-02-03 18:00:00',2),
('HNDN29A111112025020420','29A11111','HNDN','2025-02-04 20:00:00','2025-02-05 06:00:00',2),
('HNDN29A111112025020608','29A11111','HNDN','2025-02-06 08:00:00','2025-02-06 18:00:00',2),
('HNDN29A111112025020720','29A11111','HNDN','2025-02-07 20:00:00','2025-02-08 06:00:00',2),
('HNDN29A111112025020908','29A11111','HNDN','2025-02-09 08:00:00','2025-02-09 18:00:00',2),
('HNDN29A111112025021020','29A11111','HNDN','2025-02-10 20:00:00','2025-02-11 06:00:00',2),
('HNDN29A111112025021208','29A11111','HNDN','2025-02-12 08:00:00','2025-02-12 18:00:00',2),
('HNDN29A111112025021320','29A11111','HNDN','2025-02-13 20:00:00','2025-02-14 06:00:00',2),
('HNDN29A111112025021508','29A11111','HNDN','2025-02-15 08:00:00','2025-02-15 18:00:00',2),
('HNDN29A111112025021620','29A11111','HNDN','2025-02-16 20:00:00','2025-02-17 06:00:00',2),
('HNDN29A111112025021808','29A11111','HNDN','2025-02-18 08:00:00','2025-02-18 18:00:00',2),
('HNDN29A111112025021920','29A11111','HNDN','2025-02-19 20:00:00','2025-02-20 06:00:00',2),
('HNDN29A111112025022108','29A11111','HNDN','2025-02-21 08:00:00','2025-02-21 18:00:00',2),
('HNDN29A111112025022220','29A11111','HNDN','2025-02-22 20:00:00','2025-02-23 06:00:00',2),
('HNDN29A111112025022408','29A11111','HNDN','2025-02-24 08:00:00','2025-02-24 18:00:00',2),
('HNDN29A111112025022520','29A11111','HNDN','2025-02-25 20:00:00','2025-02-26 06:00:00',2),
('HNDN29A111112025022708','29A11111','HNDN','2025-02-27 08:00:00','2025-02-27 18:00:00',2),
('HNDN29A111112025022820','29A11111','HNDN','2025-02-28 20:00:00','2025-03-01 06:00:00',2),
('HNDN29A111112025030208','29A11111','HNDN','2025-03-02 08:00:00','2025-03-02 18:00:00',2),
('HNDN29A111112025030320','29A11111','HNDN','2025-03-03 20:00:00','2025-03-04 06:00:00',2),
('HNDN29A111112025030508','29A11111','HNDN','2025-03-05 08:00:00','2025-03-05 18:00:00',2),
('HNDN29A111112025030620','29A11111','HNDN','2025-03-06 20:00:00','2025-03-07 06:00:00',2),
('HNDN29A111112025030808','29A11111','HNDN','2025-03-08 08:00:00','2025-03-08 18:00:00',2),
('HNDN29A111112025030920','29A11111','HNDN','2025-03-09 20:00:00','2025-03-10 06:00:00',2),
('HNDN29A111112025031108','29A11111','HNDN','2025-03-11 08:00:00','2025-03-11 18:00:00',2),
('HNDN29A111112025031220','29A11111','HNDN','2025-03-12 20:00:00','2025-03-13 06:00:00',2),
('HNDN29A111112025031408','29A11111','HNDN','2025-03-14 08:00:00','2025-03-14 18:00:00',2),
('HNDN29A111112025031520','29A11111','HNDN','2025-03-15 20:00:00','2025-03-16 06:00:00',2),
('HNDN29A111112025031708','29A11111','HNDN','2025-03-17 08:00:00','2025-03-17 18:00:00',2),
('HNDN29A111112025031820','29A11111','HNDN','2025-03-18 20:00:00','2025-03-19 06:00:00',2),
('HNDN29A111112025032008','29A11111','HNDN','2025-03-20 08:00:00','2025-03-20 18:00:00',2),
('HNDN29A111112025032120','29A11111','HNDN','2025-03-21 20:00:00','2025-03-22 06:00:00',2),
('HNDN29A111112025032308','29A11111','HNDN','2025-03-23 08:00:00','2025-03-23 18:00:00',2),
('HNDN29A111112025032420','29A11111','HNDN','2025-03-24 20:00:00','2025-03-25 06:00:00',2),
('HNDN29A111112025032608','29A11111','HNDN','2025-03-26 08:00:00','2025-03-26 18:00:00',2),
('HNDN29A111112025032720','29A11111','HNDN','2025-03-27 20:00:00','2025-03-28 06:00:00',2),
('HNDN29A111112025032908','29A11111','HNDN','2025-03-29 08:00:00','2025-03-29 18:00:00',2),
('HNDN29A111112025033020','29A11111','HNDN','2025-03-30 20:00:00','2025-03-31 06:00:00',2),
('HNDN30C333332025042919','30C33333','HNDN','2025-04-29 19:00:00','2025-04-30 05:00:00',2),
('HNNA29B222222025051507','29B22222','HNNA','2025-05-15 07:00:00','2025-05-15 13:00:00',2),
('HNSG30C333332025041008','30C33333','HNSG','2025-04-10 08:00:00','2025-04-11 14:00:00',2),
('HNSG30E555552025052020','30E55555','HNSG','2025-05-20 20:00:00','2025-05-21 23:00:00',2);

/*Table structure for table `loai_xe` */

DROP TABLE IF EXISTS `loai_xe`;

CREATE TABLE `loai_xe` (
  `MaLoaiXe` varchar(10) NOT NULL,
  `TenLoaiXe` varchar(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `SoGhe` int(11) NOT NULL,
  PRIMARY KEY (`MaLoaiXe`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

/*Data for the table `loai_xe` */

insert  into `loai_xe`(`MaLoaiXe`,`TenLoaiXe`,`SoGhe`) values 
('GN12','Xe giường nằm 12 cabin',12),
('GN24','Xe giường nằm 24 cabin',24),
('LM09','Xe Limousine 9 chỗ',9),
('LM11','Xe Limousine 11 chỗ',11),
('LX30','Xe khách 30 chỗ',30),
('LX45','Xe khách 45 chỗ',45);

/*Table structure for table `phan_cong` */

DROP TABLE IF EXISTS `phan_cong`;

CREATE TABLE `phan_cong` (
  `MaChuyenXe` varchar(50) NOT NULL,
  `MaTaiXe` varchar(10) NOT NULL,
  `VaiTro` tinyint(4) NOT NULL,
  `ThuLao` decimal(10,2) DEFAULT 0.00,
  PRIMARY KEY (`MaChuyenXe`,`MaTaiXe`),
  UNIQUE KEY `MaChuyenXe` (`MaChuyenXe`,`VaiTro`),
  KEY `MaTaiXe` (`MaTaiXe`),
  CONSTRAINT `phan_cong_ibfk_1` FOREIGN KEY (`MaChuyenXe`) REFERENCES `chuyen_xe` (`MaChuyenXe`),
  CONSTRAINT `phan_cong_ibfk_2` FOREIGN KEY (`MaTaiXe`) REFERENCES `tai_xe` (`MaTaiXe`),
  CONSTRAINT `CONSTRAINT_1` CHECK (`VaiTro` in (1,2))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

/*Data for the table `phan_cong` */

insert  into `phan_cong`(`MaChuyenXe`,`MaTaiXe`,`VaiTro`,`ThuLao`) values 
('HNDN29A111112025010108','TX01',1,1080000.00),
('HNDN29A111112025010108','TX02',2,720000.00),
('HNDN29A111112025010220','TX01',1,1080000.00),
('HNDN29A111112025010220','TX02',2,720000.00),
('HNDN29A111112025010408','TX01',1,1080000.00),
('HNDN29A111112025010408','TX02',2,720000.00),
('HNDN29A111112025010520','TX01',1,1080000.00),
('HNDN29A111112025010520','TX02',2,720000.00),
('HNDN29A111112025010708','TX01',1,1080000.00),
('HNDN29A111112025010708','TX02',2,720000.00),
('HNDN29A111112025010820','TX01',1,1080000.00),
('HNDN29A111112025010820','TX02',2,720000.00),
('HNDN29A111112025011008','TX01',1,1080000.00),
('HNDN29A111112025011008','TX02',2,720000.00),
('HNDN29A111112025011120','TX01',1,1080000.00),
('HNDN29A111112025011120','TX02',2,720000.00),
('HNDN29A111112025011308','TX01',1,1080000.00),
('HNDN29A111112025011308','TX02',2,720000.00),
('HNDN29A111112025011420','TX01',1,1080000.00),
('HNDN29A111112025011420','TX02',2,720000.00),
('HNDN29A111112025011608','TX01',1,1080000.00),
('HNDN29A111112025011608','TX02',2,720000.00),
('HNDN29A111112025011720','TX01',1,1080000.00),
('HNDN29A111112025011720','TX02',2,720000.00),
('HNDN29A111112025011908','TX01',1,1080000.00),
('HNDN29A111112025011908','TX02',2,720000.00),
('HNDN29A111112025012020','TX01',1,1080000.00),
('HNDN29A111112025012020','TX02',2,720000.00),
('HNDN29A111112025012208','TX01',1,1080000.00),
('HNDN29A111112025012208','TX02',2,720000.00),
('HNDN29A111112025012320','TX01',1,1080000.00),
('HNDN29A111112025012320','TX02',2,720000.00),
('HNDN29A111112025012508','TX01',1,1080000.00),
('HNDN29A111112025012508','TX02',2,720000.00),
('HNDN29A111112025012620','TX01',1,1080000.00),
('HNDN29A111112025012620','TX02',2,720000.00),
('HNDN29A111112025012808','TX01',1,1080000.00),
('HNDN29A111112025012808','TX02',2,720000.00),
('HNDN29A111112025012920','TX01',1,1080000.00),
('HNDN29A111112025012920','TX02',2,720000.00),
('HNDN29A111112025013108','TX01',1,1080000.00),
('HNDN29A111112025013108','TX02',2,720000.00),
('HNDN29A111112025020120','TX01',1,1080000.00),
('HNDN29A111112025020120','TX02',2,720000.00),
('HNDN29A111112025020308','TX01',1,1080000.00),
('HNDN29A111112025020308','TX02',2,720000.00),
('HNDN29A111112025020420','TX01',1,1080000.00),
('HNDN29A111112025020420','TX02',2,720000.00),
('HNDN29A111112025020608','TX01',1,1080000.00),
('HNDN29A111112025020608','TX02',2,720000.00),
('HNDN29A111112025020720','TX01',1,1080000.00),
('HNDN29A111112025020720','TX02',2,720000.00),
('HNDN29A111112025020908','TX01',1,1080000.00),
('HNDN29A111112025020908','TX02',2,720000.00),
('HNDN29A111112025021020','TX01',1,1080000.00),
('HNDN29A111112025021020','TX02',2,720000.00),
('HNDN29A111112025021208','TX01',1,1080000.00),
('HNDN29A111112025021208','TX02',2,720000.00),
('HNDN29A111112025021320','TX01',1,1080000.00),
('HNDN29A111112025021320','TX02',2,720000.00),
('HNDN29A111112025021508','TX01',1,1080000.00),
('HNDN29A111112025021508','TX02',2,720000.00),
('HNDN29A111112025021620','TX01',1,1080000.00),
('HNDN29A111112025021620','TX02',2,720000.00),
('HNDN29A111112025021808','TX01',1,1080000.00),
('HNDN29A111112025021808','TX02',2,720000.00),
('HNDN29A111112025021920','TX01',1,1080000.00),
('HNDN29A111112025021920','TX02',2,720000.00),
('HNDN29A111112025022108','TX01',1,1080000.00),
('HNDN29A111112025022108','TX02',2,720000.00),
('HNDN29A111112025022220','TX01',1,1080000.00),
('HNDN29A111112025022220','TX02',2,720000.00),
('HNDN29A111112025022408','TX01',1,1080000.00),
('HNDN29A111112025022408','TX02',2,720000.00),
('HNDN29A111112025022520','TX01',1,1080000.00),
('HNDN29A111112025022520','TX02',2,720000.00),
('HNDN29A111112025022708','TX01',1,1080000.00),
('HNDN29A111112025022708','TX02',2,720000.00),
('HNDN29A111112025022820','TX01',1,1080000.00),
('HNDN29A111112025022820','TX02',2,720000.00),
('HNDN29A111112025030208','TX01',1,1080000.00),
('HNDN29A111112025030208','TX02',2,720000.00),
('HNDN29A111112025030320','TX01',1,1080000.00),
('HNDN29A111112025030320','TX02',2,720000.00),
('HNDN29A111112025030508','TX01',1,1080000.00),
('HNDN29A111112025030508','TX02',2,720000.00),
('HNDN29A111112025030620','TX01',1,1080000.00),
('HNDN29A111112025030620','TX02',2,720000.00),
('HNDN29A111112025030808','TX01',1,1080000.00),
('HNDN29A111112025030808','TX02',2,720000.00),
('HNDN29A111112025030920','TX01',1,1080000.00),
('HNDN29A111112025030920','TX02',2,720000.00),
('HNDN29A111112025031108','TX01',1,1080000.00),
('HNDN29A111112025031108','TX02',2,720000.00),
('HNDN29A111112025031220','TX01',1,1080000.00),
('HNDN29A111112025031220','TX02',2,720000.00),
('HNDN29A111112025031408','TX01',1,1080000.00),
('HNDN29A111112025031408','TX02',2,720000.00),
('HNDN29A111112025031520','TX01',1,1080000.00),
('HNDN29A111112025031520','TX02',2,720000.00),
('HNDN29A111112025031708','TX01',1,1080000.00),
('HNDN29A111112025031708','TX02',2,720000.00),
('HNDN29A111112025031820','TX01',1,1080000.00),
('HNDN29A111112025031820','TX02',2,720000.00),
('HNDN29A111112025032008','TX01',1,1080000.00),
('HNDN29A111112025032008','TX02',2,720000.00),
('HNDN29A111112025032120','TX01',1,1080000.00),
('HNDN29A111112025032120','TX02',2,720000.00),
('HNDN29A111112025032308','TX01',1,1080000.00),
('HNDN29A111112025032308','TX02',2,720000.00),
('HNDN29A111112025032420','TX01',1,1080000.00),
('HNDN29A111112025032420','TX02',2,720000.00),
('HNDN29A111112025032608','TX01',1,1080000.00),
('HNDN29A111112025032608','TX02',2,720000.00),
('HNDN29A111112025032720','TX01',1,1080000.00),
('HNDN29A111112025032720','TX02',2,720000.00),
('HNDN29A111112025032908','TX01',1,1080000.00),
('HNDN29A111112025032908','TX02',2,720000.00),
('HNDN29A111112025033020','TX01',1,1080000.00),
('HNDN29A111112025033020','TX02',2,720000.00),
('HNDN30C333332025042919','TX01',1,1080000.00),
('HNDN30C333332025042919','TX05',2,720000.00),
('HNNA29B222222025051507','TX02',1,660000.00),
('HNNA29B222222025051507','TX06',2,440000.00),
('HNSG30C333332025041008','TX03',1,2535000.00),
('HNSG30C333332025041008','TX04',2,1690000.00),
('HNSG30E555552025052020','TX03',1,2535000.00),
('HNSG30E555552025052020','TX04',2,1690000.00);

/*Table structure for table `tai_xe` */

DROP TABLE IF EXISTS `tai_xe`;

CREATE TABLE `tai_xe` (
  `MaTaiXe` varchar(10) NOT NULL,
  `HoTen` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `SDT` varchar(15) DEFAULT NULL,
  `NgaySinh` date DEFAULT NULL,
  `DiaChi` varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
  PRIMARY KEY (`MaTaiXe`),
  UNIQUE KEY `SDT` (`SDT`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

/*Data for the table `tai_xe` */

insert  into `tai_xe`(`MaTaiXe`,`HoTen`,`SDT`,`NgaySinh`,`DiaChi`) values 
('TX01','Nguyễn Văn An','0901112221','1985-05-20','Hà Nội'),
('TX02','Trần Đức Bình','0901112222','1990-11-15','Hải Phòng'),
('TX03','Lê Thị Cẩm','0901112223','1992-02-10','Đà Nẵng'),
('TX04','Phạm Văn Dũng','0901112224','1988-07-30','Nghệ An'),
('TX05','Hoàng Thị Em','0901112225','1995-09-05','TP. Hồ Chí Minh'),
('TX06','Vũ Minh Long','0901112226','1980-01-12','Hà Nội');

/*Table structure for table `tuyen_duong` */

DROP TABLE IF EXISTS `tuyen_duong`;

CREATE TABLE `tuyen_duong` (
  `MaTuyenDuong` varchar(4) NOT NULL,
  `DiemDau` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `DiemCuoi` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
  `DoPhucTap` int(11) DEFAULT NULL CHECK (`DoPhucTap` in (1,2,3)),
  `DoDai` int(11) NOT NULL,
  PRIMARY KEY (`MaTuyenDuong`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

/*Data for the table `tuyen_duong` */

insert  into `tuyen_duong`(`MaTuyenDuong`,`DiemDau`,`DiemCuoi`,`DoPhucTap`,`DoDai`) values 
('HNDN','Hà Nội','Đà Nẵng',2,500),
('HNNA','Hà Nội','Nghệ An',1,300),
('HNSG','Hà Nội','Sài Gòn',3,1200);

/*Table structure for table `ve_xe` */

DROP TABLE IF EXISTS `ve_xe`;

CREATE TABLE `ve_xe` (
  `MaVe` varchar(100) NOT NULL,
  `MaChuyenXe` varchar(50) NOT NULL,
  `ViTri` varchar(10) NOT NULL,
  `TenHanhKhach` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
  `SDTHanhKhach` varchar(15) DEFAULT NULL,
  `GiaVeThucTe` decimal(10,2) DEFAULT NULL,
  PRIMARY KEY (`MaVe`),
  UNIQUE KEY `MaChuyenXe` (`MaChuyenXe`,`ViTri`),
  CONSTRAINT `ve_xe_ibfk_1` FOREIGN KEY (`MaChuyenXe`) REFERENCES `chuyen_xe` (`MaChuyenXe`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

/*Data for the table `ve_xe` */

insert  into `ve_xe`(`MaVe`,`MaChuyenXe`,`ViTri`,`TenHanhKhach`,`SDTHanhKhach`,`GiaVeThucTe`) values 
('HNDN30C333332025042919_C01','HNDN30C333332025042919','C01','Khách C1','0912345678',720000.00),
('HNDN30C333332025042919_C02','HNDN30C333332025042919','C02','Khách C2','0912345679',720000.00),
('HNNA29B222222025051507_D10','HNNA29B222222025051507','D10','Khách D10','0955555555',220000.00),
('HNSG30C333332025041008_A01','HNSG30C333332025041008','A01','Khách A1','0987654321',900000.00),
('HNSG30C333332025041008_A02','HNSG30C333332025041008','A02','Khách A2','0987654322',900000.00),
('HNSG30C333332025041008_B05','HNSG30C333332025041008','B05','Khách B5','0987654323',900000.00),
('HNSG30E555552025052020_P01','HNSG30E555552025052020','P01','Khách P1','0966666666',1200000.00),
('HNSG30E555552025052020_P02','HNSG30E555552025052020','P02','Khách P2','0966666667',1200000.00),
('HNSG30E555552025052020_P03','HNSG30E555552025052020','P03','Khách P3','0966666668',1200000.00);

/*Table structure for table `xe_khach` */

DROP TABLE IF EXISTS `xe_khach`;

CREATE TABLE `xe_khach` (
  `MaXe` varchar(8) NOT NULL,
  `MaLoaiXe` varchar(10) NOT NULL,
  `SoNgayBDConLai` int(11) DEFAULT 360,
  `HanDangKiem` date DEFAULT NULL,
  PRIMARY KEY (`MaXe`),
  KEY `MaLoaiXe` (`MaLoaiXe`),
  CONSTRAINT `xe_khach_ibfk_1` FOREIGN KEY (`MaLoaiXe`) REFERENCES `loai_xe` (`MaLoaiXe`),
  CONSTRAINT `CONSTRAINT_1` CHECK (`SoNgayBDConLai` <= 360)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

/*Data for the table `xe_khach` */

insert  into `xe_khach`(`MaXe`,`MaLoaiXe`,`SoNgayBDConLai`,`HanDangKiem`) values 
('29A11111','LX45',0,'2025-12-10'),
('29B22222','LX30',357,'2026-02-20'),
('30C33333','GN24',338,'2025-11-05'),
('30D44444','LM09',360,'2026-04-15'),
('30E55555','GN12',344,'2025-09-30');

/* Trigger structure for table `chuyen_xe` */

DELIMITER $$

/*!50003 DROP TRIGGER*//*!50032 IF EXISTS */ /*!50003 `trg_before_insert_chuyen_xe` */$$

/*!50003 CREATE */ /*!50017 DEFINER = 'root'@'localhost' */ /*!50003 TRIGGER `trg_before_insert_chuyen_xe` BEFORE INSERT ON `chuyen_xe` FOR EACH ROW 
BEGIN
    SET NEW.MaChuyenXe = CONCAT(NEW.MaTuyenDuong, NEW.MaXe, DATE_FORMAT(NEW.GioDi, '%Y%m%d%H'));
END */$$


DELIMITER ;

/* Trigger structure for table `ve_xe` */

DELIMITER $$

/*!50003 DROP TRIGGER*//*!50032 IF EXISTS */ /*!50003 `trg_before_insert_ve_xe` */$$

/*!50003 CREATE */ /*!50017 DEFINER = 'root'@'localhost' */ /*!50003 TRIGGER `trg_before_insert_ve_xe` BEFORE INSERT ON `ve_xe` FOR EACH ROW 
BEGIN
    DECLARE so_ghe_max INT;
    DECLARE so_ve_hien_tai INT;
    DECLARE var_MaLoaiXe VARCHAR(10);
    DECLARE var_MaTuyenDuong VARCHAR(4);
    DECLARE var_GioDi DATETIME;
    DECLARE var_GiaVeNiemYet DECIMAL(10, 2);

    SELECT cx.MaXe, cx.MaTuyenDuong, cx.GioDi INTO @ma_xe, var_MaTuyenDuong, var_GioDi
    FROM CHUYEN_XE cx WHERE cx.MaChuyenXe = NEW.MaChuyenXe;

    SELECT xk.MaLoaiXe INTO var_MaLoaiXe
    FROM XE_KHACH xk WHERE xk.MaXe = @ma_xe;

    SELECT lx.SoGhe - 2 INTO so_ghe_max
    FROM LOAI_XE lx WHERE lx.MaLoaiXe = var_MaLoaiXe;

    SELECT COUNT(*) INTO so_ve_hien_tai
    FROM VE_XE vx WHERE vx.MaChuyenXe = NEW.MaChuyenXe;

    IF so_ve_hien_tai >= so_ghe_max THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Số lượng vé đã đạt tối đa cho phép của chuyến xe này.';
    END IF;

    SELECT bg.GiaVeNiemYet INTO var_GiaVeNiemYet
    FROM BANG_GIA bg
    WHERE bg.MaTuyenDuong = var_MaTuyenDuong
      AND bg.MaLoaiXe = var_MaLoaiXe
      AND bg.NgayBatDau <= DATE(var_GioDi)
    ORDER BY bg.NgayBatDau DESC
    LIMIT 1;

    SET NEW.GiaVeThucTe = var_GiaVeNiemYet;
    
    SET NEW.MaVe = CONCAT(NEW.MaChuyenXe, '_', NEW.ViTri);
END */$$


DELIMITER ;

/*!50106 set global event_scheduler = 1*/;

/* Event structure for event `ev_cap_nhat_chuyen_xe_hoan_thanh` */

/*!50106 DROP EVENT IF EXISTS `ev_cap_nhat_chuyen_xe_hoan_thanh`*/;

DELIMITER $$

/*!50106 CREATE DEFINER=`root`@`localhost` EVENT `ev_cap_nhat_chuyen_xe_hoan_thanh` ON SCHEDULE EVERY 1 HOUR STARTS '2025-09-29 22:38:20' ON COMPLETION NOT PRESERVE ENABLE DO BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_MaChuyenXe VARCHAR(50);
    DECLARE v_MaXe VARCHAR(8);
    DECLARE v_MaTuyenDuong VARCHAR(4);
    DECLARE v_DoDai INT;
    DECLARE v_DoPhucTap INT;
    DECLARE luong_co_ban DECIMAL(10, 2) DEFAULT 100000.00;

    DECLARE cur CURSOR FOR
        SELECT MaChuyenXe, MaXe, MaTuyenDuong
        FROM CHUYEN_XE
        WHERE TrangThai = 1 AND GioDen < NOW();

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    OPEN cur;

    read_loop: LOOP
        FETCH cur INTO v_MaChuyenXe, v_MaXe, v_MaTuyenDuong;
        IF done THEN
            LEAVE read_loop;
        END IF;

        SELECT DoDai, DoPhucTap INTO v_DoDai, v_DoPhucTap
        FROM TUYEN_DUONG WHERE MaTuyenDuong = v_MaTuyenDuong;

        UPDATE PHAN_CONG
        SET ThuLao = luong_co_ban
                     * (CASE WHEN VaiTro = 1 THEN 1.5 ELSE 1.0 END)
                     * (1 + v_DoDai / 100.0)
                     * (1 + v_DoPhucTap / 10.0)
        WHERE MaChuyenXe = v_MaChuyenXe;

        UPDATE XE_KHACH
        SET SoNgayBDConLai = SoNgayBDConLai - (v_DoDai * (1 + v_DoPhucTap / 10.0) / 100.0)
        WHERE MaXe = v_MaXe;

        UPDATE CHUYEN_XE
        SET TrangThai = 2
        WHERE MaChuyenXe = v_MaChuyenXe;

    END LOOP;

    CLOSE cur;
END */$$
DELIMITER ;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
